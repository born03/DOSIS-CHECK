<script>
    let pasos = [], pendientes = [], indice = 0;
    let voiceActive = false;
    const synth = window.speechSynthesis;

    function hablar(t) {
        if (!t || !voiceActive) return; 
        synth.cancel();
        const u = new SpeechSynthesisUtterance(t
            .replace(/\bIV\b/gi, "Intravenosa")
            .replace(/\bIM\b/gi, "Intramuscular")
            .replace(/\bVO\b/gi, "Vía Oral")
            .replace(/\bPRN\b/gi, "Por razón necesaria")
            .replace(/\bC\//gi, "Cada ")
            .replace(/\bMG\b/gi, "miligramos")
        );
        u.lang = 'es-MX'; u.rate = 1.0;
        synth.speak(u);
    }

    document.getElementById('docInput').addEventListener('change', async function(e) {
        const files = Array.from(e.target.files);
        const turno = document.getElementById('turnoSelect').value;
        const hTurnos = { 
            matutino:[14,15,16,17,18,19,20,21], 
            vespertino:[22,23,0,1,2,3], 
            nocturno:[4,5,6,7,8,9,10,11,12,13] 
        };
        
        pasos = [];
        for (const file of files) {
            const buffer = await file.arrayBuffer();
            const res = await mammoth.convertToHtml({arrayBuffer: buffer});
            const div = document.createElement('div'); div.innerHTML = res.value;
            const rows = Array.from(div.querySelectorAll('tr'));
            
            rows.slice(2).forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 3) {
                    const cam = cols[0].innerText.trim();
                    const nom = cols[1].innerText.trim();
                    const medsRaw = cols[2].innerHTML.split(/<p>|<br>|<div>/);
                    const obs = cols[3] ? cols[3].innerText.trim() : "Sin observaciones";
                    
                    if(nom.length > 2) {
                        medsRaw.forEach(m => {
                            let text = m.replace(/<[^>]*>?/gm, '').trim();
                            if(!text || text.length < 3) return;

                            // 1. FILTRO PRN: Si contiene PRN, lo ignoramos totalmente
                            if (/\bPRN\b/i.test(text)) return;

                            // 2. BUSCAR HORARIOS FIJOS (Ej: 8-16-24) al final de la línea
                            const matchHoras = text.match(/(\d{1,2}(?:-\d{1,2})*)$/);
                            
                            // 3. BUSCAR FRECUENCIAS (Ej: C/8h, C/24h, Cada 12 hrs)
                            const esFrecuencia = /(C\/|CADA)\s*\d+/i.test(text);
                            
                            // 4. TEXTOS ESPECIALES (Previo a, Sin horario, Tachado)
                            const esEspecial = /(PREVIO|TACHADO|POR DEFINIR|INDICACIÓN)/i.test(text);

                            if(matchHoras) {
                                // Caso normal: Tiene horas definidas
                                const horasEnTexto = matchHoras[0].split('-');
                                horasEnTexto.forEach(h => {
                                    let horaNum = parseInt(h === '24' ? '0' : h);
                                    if(hTurnos[turno].includes(horaNum)) {
                                        pasos.push({ 
                                            cam, nom, 
                                            med: text.replace(matchHoras[0], '').trim(), 
                                            hora: h + ":00", 
                                            obs, 
                                            tipo: 'fijo' 
                                        });
                                    }
                                });
                            } 
                            else if (esFrecuencia || esEspecial) {
                                // Caso C/8h o Previo a: Lo incluimos siempre en el turno para que no se escape
                                pasos.push({ 
                                    cam, nom, 
                                    med: text, 
                                    hora: "PENDIENTE", 
                                    obs: "⚠️ " + (esFrecuencia ? "Revisar frecuencia" : "Indicación especial"), 
                                    tipo: 'especial' 
                                });
                            }
                        });
                    }
                }
            });
        }
        if(pasos.length > 0) {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('viewer').classList.remove('hidden');
            mostrar(false);
        }
    });

    function mostrar(conVoz) {
        const p = pasos[indice];
        document.getElementById('pNom').innerText = p.nom;
        document.getElementById('pCam').innerText = "CAMA " + p.cam;
        document.getElementById('mDet').innerText = p.med;
        
        const horElem = document.getElementById('mHor');
        horElem.innerText = p.hora === "PENDIENTE" ? "HORARIO MANUAL" : p.hora + " HRS";
        horElem.style.background = p.hora === "PENDIENTE" ? "rgba(255, 69, 58, 0.2)" : "rgba(48, 209, 88, 0.1)";
        
        document.getElementById('mObs').innerText = p.obs;
        
        const progreso = ((indice + 1) / pasos.length) * 100;
        document.getElementById('pFill').style.width = progreso + "%";

        if (conVoz && voiceActive) {
            let infoHora = p.hora === "PENDIENTE" ? "con horario por definir" : `a las ${p.hora}`;
            let guion = (indice > 0 && pasos[indice].nom === pasos[indice - 1].nom) 
                ? `Mismo paciente. ${p.med}. ${infoHora}.` 
                : `Paciente ${p.nom}. Cama ${p.cam}. ${p.med}. ${infoHora}.`;
            hablar(guion);
        }
    }
    // ... (Resto de funciones: iniciarVoz, siguiente, finalizar son iguales)
</script>
