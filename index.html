<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación de Pase de Guardia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos para el Vaciado Final (Hoja Blanca) */
        #vaciado-final {
            background-color: white;
            color: black;
            padding: 40px;
            min-height: 100vh;
        }
        
        .servicio-header {
            font-size: 1.4rem;
            font-weight: bold;
            border-bottom: 2px solid black;
            margin-top: 30px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .paciente-row {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        .med-lista {
            margin-left: 20px;
            list-style-type: none;
        }

        @media print {
            .no-print { display: none; }
            #vaciado-final { padding: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Interfaz de Control -->
    <div class="no-print max-w-4xl mx-auto p-6 bg-white shadow-lg mt-6 rounded-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">Verificador de Medicación</h1>
        
        <div class="mb-4">
            <label class="block font-medium mb-1">Pega aquí la información de los pacientes:</label>
            <textarea id="textoEntrada" class="w-full h-48 p-4 border rounded-md border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                placeholder="Ejemplo: 550 Juan Perez - Enalapril 10mg C/12h, Paracetamol 1g 08:00, Ondansetron PRN"></textarea>
        </div>

        <div class="flex gap-4 mb-6">
            <button onclick="procesarVaciado()" class="bg-black text-white px-6 py-2 rounded font-bold hover:bg-gray-800 transition">
                GENERAR VACIADO
            </button>
            <button onclick="hablarReporte()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition flex items-center">
                <span class="mr-2">▶</span> ESCUCHAR REPORTE
            </button>
            <button onclick="window.print()" class="bg-gray-200 text-black px-6 py-2 rounded font-bold hover:bg-gray-300 transition">
                IMPRIMIR HOJA
            </button>
        </div>
        
        <p class="text-sm text-gray-500 italic border-t pt-2">
            * Se eliminan automáticamente medicamentos PRN/SOS.
            * Las horas se leen como "cero cero" (sin decir "en punto").
            * Las frecuencias "C/..." se traducen a "Cada... horas".
        </p>
    </div>

    <!-- Hoja Blanca de Vaciado -->
    <div id="vaciado-final" class="max-w-4xl mx-auto mt-10 shadow-sm border border-gray-200">
        <div id="contenido-reporte">
            <p class="text-gray-400 text-center py-20 italic">Ingresa datos arriba para generar el reporte en hoja blanca.</p>
        </div>
    </div>

    <script>
        const SERVICIOS = [
            { nombre: "ONCOLOGÍA", min: 220, max: 245 },
            { nombre: "INFECTOLOGÍA", min: 501, max: 521 },
            { nombre: "CIRUGÍA", min: 522, max: 535 },
            { nombre: "GASTROENTEROLOGÍA", min: 536, max: 542 },
            { nombre: "TRAUMATOLOGÍA", min: 543, max: 549 },
            { nombre: "MEDICINA INTERNA", min: 550, max: 559 }
        ];

        let datosProcesados = [];

        function obtenerServicio(cama) {
            const num = parseInt(cama);
            const serv = SERVICIOS.find(s => num >= s.min && num <= s.max);
            return serv ? serv.nombre : "SERVICIO DESCONOCIDO";
        }

        function limpiarMedicamento(texto) {
            const t = texto.toUpperCase();
            // Regla: No PRN ni SOS
            if (t.includes("PRN") || t.includes("SOS")) return null;
            
            // Traducir frecuencia para el texto
            let limpio = texto.trim();
            limpio = limpio.replace(/C\/(\d+)\s*H/gi, "Cada $1 horas");
            limpio = limpio.replace(/C\/(\d+)/gi, "Cada $1 horas");
            
            return limpio;
        }

        function procesarVaciado() {
            const entrada = document.getElementById('textoEntrada').value;
            const lineas = entrada.split('\n').filter(l => l.trim() !== "");
            const contenedor = document.getElementById('contenido-reporte');
            contenedor.innerHTML = "";
            datosProcesados = [];

            let currentServName = "";

            lineas.forEach(linea => {
                const matchCama = linea.match(/(\d{3})/);
                if (matchCama) {
                    const cama = matchCama[1];
                    const servicio = obtenerServicio(cama);
                    
                    // Separar nombre y medicamentos (asume formato simple)
                    const partes = linea.split(cama);
                    const resto = partes[1] ? partes[1].split('-') : ["", ""];
                    const nombre = resto[0] ? resto[0].trim() : "Paciente";
                    const medsRaw = resto[1] ? resto[1].split(',') : (resto[0].includes(',') ? resto[0].split(',') : []);

                    const medsLimpios = medsRaw
                        .map(m => limpiarMedicamento(m))
                        .filter(m => m !== null);

                    if (medsLimpios.length > 0) {
                        // Agrupar por servicio visualmente
                        if (servicio !== currentServName) {
                            const h = document.createElement('div');
                            h.className = "servicio-header";
                            h.innerText = `SERVICIO: ${servicio}`;
                            contenedor.appendChild(h);
                            currentServName = servicio;
                        }

                        const divP = document.createElement('div');
                        divP.className = "paciente-row";
                        divP.innerHTML = `<strong>Cama ${cama}</strong> - ${nombre}`;
                        
                        const ul = document.createElement('ul');
                        ul.className = "med-lista";
                        medsLimpios.forEach(m => {
                            const li = document.createElement('li');
                            li.innerText = `• ${m}`;
                            ul.appendChild(li);
                        });
                        
                        divP.appendChild(ul);
                        contenedor.appendChild(divP);

                        datosProcesados.push({ servicio, cama, nombre, medicamentos: medsLimpios });
                    }
                }
            });
        }

        function hablarReporte() {
            if (datosProcesados.length === 0) return;

            window.speechSynthesis.cancel();
            let currentService = "";

            datosProcesados.forEach(p => {
                let narracion = "";
                
                if (p.servicio !== currentService) {
                    narracion += `Servicio ${p.servicio}. `;
                    currentService = p.servicio;
                }

                narracion += `Cama ${p.cama}. ${p.nombre}. `;
                
                p.medicamentos.forEach(m => {
                    // Reemplazar :00 por "cero cero" para evitar el "en punto"
                    let lecturaMed = m.replace(/:00/g, " cero cero");
                    // Asegurar que diga "Cada X horas"
                    lecturaMed = lecturaMed.replace(/C\/(\d+)H/gi, "Cada $1 horas");
                    
                    narracion += `Medicamento: ${lecturaMed}. `;
                });

                const utterance = new SpeechSynthesisUtterance(narracion);
                utterance.lang = 'es-MX';
                utterance.rate = 0.85; // Velocidad pausada
                window.speechSynthesis.speak(utterance);
            });
        }
    </script>
</body>
</html>
